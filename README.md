# AWSOM (Adaptive Weights Smoothing with Optimized Metrics) Filter

## Overview

This repository provides the **AWSOM** (Adaptive Weights Smoothing with Optimized Metrics) algorithm for fMRI data processing. The script `awsom.R` runs the AWSOM filter, which smooths fMRI data based on optimized metrics, producing p-value activity maps, and filtered beta-value maps. This tool is particularly useful for enhancing statistical results from General Linear Model (GLM) analysis of fMRI data.

## Requirements

### Software

To run the AWSOM filter, you will need:

- **R** (version â‰¥ 3.0)
- **FSL** (FMRIB Software Library) to convert p-values to z-values. Ensure that FSL is correctly installed and accessible from your terminal.

### R Libraries

Ensure the following R libraries are installed:

- [`fmri`](https://CRAN.R-project.org/package=fmri)
- [`RNifti`](https://cran.r-project.org/web/packages/RNifti/index.html)
- [`oro.nifti`](https://cran.r-project.org/web/packages/oro.nifti/index.html)

### fMRI Data Requirements

The AWSOM filter requires files generated by a first-level GLM analysis (e.g., using FSL). The required inputs are:

1. **COPE (Contrast of Parameter Estimate)**: beta map (contrast parameter) file
2. **Residuals**: residual noise map
3. **Variance COPE**: variance map of the COPE
4. **Brain Mask**: binary brain mask
5. **Number of Regressors**: an integer indicating the number of regressors used in your GLM analysis

## File Naming Convention

If you used **FSL** for your GLM analysis, these files are typically located in the `stats` subfolder of the `.feat` directory. The default file names are:

- `cope*.nii.gz` (COPE file)
- `res4d.nii.gz` (residuals file)
- `varcope*.nii.gz` (variance COPE file)
- A brain mask

## Running the AWSOM Filter

To run the AWSOM filter, use the following inputs in `awsom.R`:

- **`copePath`**: Path to the COPE file.
- **`residualsPath`**: Path to the residuals file.
- **`varianceCopePath`**: Path to the COPE variance file.
- **`maskPath`**: Path to the binary brain mask file.
- **`numRegressors`**: Integer representing the number of regressors in the GLM.
- **`outputPath`**: Directory where the output files will be saved.

### Example to run it from the bash terminal:

```r
copePath=/path/to/cope.nii.gz
residualsPath=/path/to/res4d.nii.gz
varianceCopePath=/path/to/varcope.nii.gz
maskPath=/path/to/mask.nii.gz
numRegressors=3
outputPath=/path/to/output/directory/
Rscript awsom.R "$copePath" "$residualsPath" "$varianceCopePath" "$maskPath" "$numRegressors" "$outputPath"

# Switching p-value maps to z-values:
fslmaths $outputPath/AWSOM_pVal.nii -ptoz $outputPath/AWSOM_zStat.nii.gz
```
### AWSOM Filter and Comparisons

For more details about the AWSOM filter, its tests, and comparisons with Gaussian and non-local filters, refer to the publication: [Precision fMRI and cluster-failure in the individual brain](https://onlinelibrary.wiley.com/doi/10.1002/hbm.26813).



For information regarding the AWS filter, please refer to: [Analyzing fMRI experiments with structural adaptive smoothing procedures](https://www.sciencedirect.com/science/article/abs/pii/S1053811906007117?via%3Dihub).


Any questions, comments or suggestions can be directed to:

Igor Tellez [igor.tellez@gmail.com](mailto:igor.tellez@gmail.com)

Karsten Tabelow [karsten.tabelow@wias-berlin.de](mailto:karsten.tabelow@wias-berlin.de)
